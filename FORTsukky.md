# FORTsukky.md — 街deai（まちであい）

## これ、なにを作ったの？

「引っ越したいけど、どこに住めばいいかわからない」問題を解決するWebアプリ。

SUUMOやHOMESは「駅徒歩○分、家賃○万円以下」みたいに**条件で絞る**サービス。でもそもそも「自分に合う街ってどこ？」という問いには答えてくれない。知らない街には出会えない。

**街deai** は、今好きな街を教えてくれれば、「似た雰囲気だけどまだ知らない街」をTinder風スワイプで紹介してくれる。街の魅力は、テレビ番組「アド街ック天国」みたいにTOP10ランキング形式で見せる。気に入ったらSUUMOで物件検索まで一気通貫。

---

## 技術スタック — なぜこれを選んだか

### Next.js 16 (App Router) + TypeScript

Next.jsは「Reactでサイトを作るなら最初に検討するフレームワーク」。App Routerはサーバーコンポーネント（HTMLをサーバー側で組み立てる）とクライアントコンポーネント（ブラウザ側で動く）を自然に使い分けられる。

**なぜNext.js？**
- 街の詳細ページは30ページ分を**ビルド時に全部HTMLにしておく**（静的生成 = SSG）。アクセスした瞬間に表示されて速い（4ms以下）。
- TypeScriptで型を定義しておくと、「この街データにはcatchcopyフィールドが必須」みたいなルールをコードが自動チェックしてくれる。タイポで30分溶かすリスクが減る。

### Tailwind CSS v4

CSSを書かずに、HTMLタグに直接`className="text-sm font-bold mb-3"`みたいにスタイルを指定する。`@theme inline`構文でカスタムカラーも定義可能。「デザイン作業」と「コーディング作業」が同時にできて、MVP向き。

### framer-motion（動的import）

Tinder風スワイプのアニメーションを実現するライブラリ。ドラッグ操作→カードが飛んでいく→次のカードが出てくる、をスムーズに実装できる。自前で書くと地獄なので、ライブラリの力を借りるのが正解。

**改善ポイント**: framer-motionはバンドルサイズが大きいため、`dynamic(() => import(...), { ssr: false })`で動的importにした。これでdiscoverページだけがframer-motionをロードし、他のページは軽量に保てる。SpotCardのアニメーションはCSSの`@keyframes`に置き換えて、町詳細ページからframer-motion依存を完全除去した。

### 静的JSON（DBなし）

30街分のデータは全部1つのJSONファイルに入っている。データベース（DB）は使わない。「MVPで最小工数」という目標に対して、DBの構築・運用コストは過剰。JSONならGitで管理できて、Vercelに無料でデプロイできる。

---

## アーキテクチャ — コードの全体像

```
src/
├── app/              ← ページ（URL = フォルダ構成）
│   ├── page.tsx          オンボーディング（街選択 + 通勤先入力）
│   ├── discover/         スワイプ出会い画面
│   ├── town/[slug]/      街詳細（アド街風TOP10）
│   └── bookmarks/        ブックマーク一覧
├── components/       ← 再利用可能なUI部品
│   ├── SwipeStack.tsx    カードスワイプの心臓部
│   ├── TownPicker.tsx    街の複数選択UI（クイックピック付き）
│   ├── TownCard.tsx      カード表示（カラーテーマ対応）
│   ├── SpotCard.tsx      ランキング表示（CSSアニメーション）
│   └── ...
├── lib/              ← ロジック（計算・データ操作）
│   ├── recommend.ts      「似た街」スコアリング
│   └── bookmarks.ts      ブックマーク管理
├── data/
│   └── towns.json        30街分の全データ
├── types/
│   └── town.ts           データの型定義
scripts/
└── generate-towns.mjs    街データ生成スクリプト
```

### データの流れ

1. **オンボーディング**（`page.tsx`）
   - 「好きな街」を複数選ぶ（人気9街はクイックピックで1タップ選択）
   - 「今住んでる街」を1つ選ぶ（任意）
   - 通勤先の駅を入力（任意）
   - URLパラメータに情報を載せて `/discover` に遷移

2. **レコメンドエンジン**（`recommend.ts`）
   - 好きな街すべてのvibeタグを集める
   - 各候補街との**Jaccard類似度**でスコアリング
   - 通勤30分以内でフィルタ
   - 知名度が低い街にボーナス加点（穴場推し）

3. **スワイプ画面**（`discover/`）
   - レコメンド順にカードが積まれる
   - 左右スワイプ or 「スキップ」「詳しく見る」ボタンで操作
   - 各カードは街のカラーテーマでグラデーション表示

4. **街詳細**（`town/[slug]/`）
   - アド街風TOP10ランキング（CSSアニメーションで順番にフェードイン）
   - 家賃相場、路線情報、vibeタグ（街のテーマカラー）
   - SUUMO/HOMESリンク
   - 類似する街のレコメンド（カラードット付き）

### カラーテーマシステム

各街に`colorFrom`と`colorTo`の2色を持たせ、街の雰囲気を色で表現。画像がない段階でも、カードや詳細ページのヒーロー部分が鮮やかに表示される。下北沢はパープル（サブカル）、吉祥寺はグリーン（自然）、高円寺はレッド（パンク）など。

### 「似た街」ロジックを料理に例えると

Jaccard類似度は「材料の共通度」。

あなたが「下北沢」と「高円寺」を好きだと言ったとする。下北沢のvibeは `["カルチャー", "古着", "サブカル", "カフェ", "ライブ"]`、高円寺は `["カルチャー", "古着", "ライブ", "カレー", "下町"]`。

マージすると `["カルチャー", "古着", "サブカル", "カフェ", "ライブ", "カレー", "下町"]` の7タグ。

これと各街のvibeタグを比較して、共通タグ数 ÷ 合計タグ数（重複除く）= Jaccard類似度。この数値が高い街ほど「あなたの好みに近い」と判定される。

さらに、知名度スコア（popularity）が低い街にはボーナスを加算する。吉祥寺（知名度5）より西荻窪（知名度2）を上に持ってくることで「知らなかった！」という発見体験を生む。

---

## 学び — 作りながら気づいたこと

### 1. データ生成は想像以上にコストがかかる

30街 × 10スポット × 各種メタデータ = 相当な分量。LLMで生成する場合、1回で全部作ろうとするとトークン（≒文字量課金）が爆発する。最終的にNode.jsスクリプト（`scripts/generate-towns.mjs`）にデータを直書きして1回の実行で書き出す方式に落ち着いた。

**教訓**: データ量が多い場合、スクリプトに閉じ込めて1回実行する方が、対話的に生成するより遥かに効率的。

### 2. devサーバーのCompiling問題 → productionビルドで解決

Next.jsの開発サーバー（`next dev`）は、ページにアクセスするたびにオンデマンドコンパイルを行う。framer-motionのような大きなライブラリがあると、ページ遷移のたびに数秒のCompiling待ちが発生する。

**解決策**: 2つのアプローチを併用した。
1. `npm run build && npm start` でproductionビルドしたものを配信（Compiling待ちゼロ、全ページ4ms以下）
2. framer-motionを`dynamic import`にし、SpotCardのアニメーションをCSSに置き換えてバンドルサイズを削減

**教訓**: 開発中に「遅い」と感じたら、まずproductionビルドで確認。dev固有の問題なのか、本当のパフォーマンス問題なのかを切り分けるのが先。

### 3. Next.js App Routerのサーバー/クライアントコンポーネントの使い分け

`town/[slug]/page.tsx`はサーバーコンポーネント（データ取得 + 関連街の計算）、`TownDetailClient.tsx`はクライアントコンポーネント（ブックマーク等のインタラクション）。この分離パターンは頻出。サーバー側でデータを整形してからクライアントに渡すことで、ブラウザに送るJavaScriptの量を減らせる。

### 4. `generateStaticParams` で全ページ事前生成

```typescript
export async function generateStaticParams() {
  return getTownSlugs().map((slug) => ({ slug }));
}
```

この4行で「30街分のHTMLをビルド時に作っておく」が実現する。ユーザーがアクセスした瞬間にHTMLが返るので爆速。DBも要らない。**静的サイトの力を侮るべからず**。

### 5. framer-motionのドラッグ制御 — 3つの落とし穴

- **xリセット問題**: `useMotionValue`のx値がカード切り替え時にリセットされない → `useEffect`で`x.set(0)`を追加
- **ドラッグ/タップ混同**: ドラッグ操作がタップとして誤判定される → `isDragging`ステートと`setTimeout`で分離
- **バンドルサイズ**: スワイプだけに使うのにページ全体が重くなる → dynamic importでdiscoverページ限定に

### 6. localStorageの扱い

Next.jsはサーバーサイドレンダリング（SSR）もするので、`typeof window !== "undefined"` のチェックが必要。これを忘れると「windowが定義されていません」というエラーでビルドが死ぬ。

### 7. UIデザインの「画像がない問題」への対処

写真を用意できない段階でもアプリが映えるように、**カラーテーマシステム**を導入。各街に2色のグラデーションを持たせ、vibeの雰囲気を色で表現する。さらにTownCardには巨大な街名のウォーターマークを薄く重ねて、視覚的な奥行きを出した。画像は後から追加できる設計（`image`フィールドが空文字ならグラデーション表示、URLが入れば背景画像表示）。

### 8. エンジニアの思考法 — 「最小限で動くもの」を最速で

MVPの鉄則は「機能を削ること」。最初の構想では50街・通勤フィルタ・Tinder風スワイプ・アド街風ランキング・ブックマーク・SUUMO連携…と盛りだくさんだったが、全部実装した。ただしデータは30街に抑え、画像はなし（URLは空文字）。**動くものを見てから磨く**。これがプロの判断。

---

## 30街リスト（2025年1月版）

| エリア | 街名 | カラーテーマ | 知名度 |
|--------|------|-------------|--------|
| 世田谷区 | 下北沢 | パープル | ★★★★★ |
| 武蔵野市 | 吉祥寺 | グリーン | ★★★★★ |
| 目黒区 | 中目黒 | ピンク | ★★★★★ |
| 台東区 | 谷中 | アンバー | ★★★ |
| 杉並区 | 高円寺 | レッド | ★★★★ |
| 杉並区 | 西荻窪 | ストーン | ★★ |
| 世田谷区 | 三軒茶屋 | オレンジ | ★★★★ |
| 新宿区 | 神楽坂 | バイオレット | ★★★ |
| 江東区 | 清澄白河 | シアン | ★★★ |
| 品川区 | 戸越銀座 | イエロー | ★★ |
| 世田谷区 | 池尻大橋 | ティール | ★★ |
| 台東区 | 浅草 | レッド | ★★★★★ |
| 渋谷区 | 恵比寿 | インディゴ | ★★★★★ |
| 品川区 | 武蔵小山 | ゴールド | ★★ |
| 港区 | 芝公園 | ネイビー | ★★ |
| 世田谷区 | 下高井戸 | ライム | ★ |
| 目黒区 | 学芸大学 | ローズ | ★★★ |
| 荒川区 | 西日暮里 | ブラウン | ★ |
| 世田谷区 | 二子玉川 | スカイ | ★★★★ |
| 足立区 | 北千住 | オレンジブラウン | ★★★ |
| 江東区 | 門前仲町 | ダークレッド | ★★ |
| 世田谷区 | 三宿 | スレート | ★ |
| 目黒区 | 都立大学 | エメラルド | ★★ |
| 文京区 | 根津 | テラコッタ | ★★ |
| 台東区 | 蔵前 | ブルー | ★★ |
| 北区 | 赤羽 | レッド | ★★★ |
| 中野区 | 中野 | パープル | ★★★★ |
| 中央区 | 人形町 | ブラウンゴールド | ★★ |
| 豊島区 | 雑司が谷 | ディープパープル | ★ |
| 目黒区 | 自由が丘 | マゼンタ | ★★★★★ |
